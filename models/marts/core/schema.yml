version: 2

models:
  - name: fct_orders
    description: Order-level fact table with lifetime metrics and customer funnel context
    config:
      meta:
        kpis:
          - kpiName: 'Net Revenue'
            acronym: ''
            description: 'Total order revenue after discounts, before tax'
            calculation: 'subtotal_price'
            sourceFieldName: 'net_sales'
            granularity: 'Order'
            uniqueKey: 'order_id'
            dataType: 'currency'
            department: 'Executive'
            dataOwner: ''
            businessOwner: ''
            note: 'Primary revenue metric - corresponds to wishlist section 1.1'

          - kpiName: 'Product Orders'
            acronym: ''
            description: 'Orders with product_quantity > 0 AND net_sales > $250'
            calculation: 'count where order_type = Product Order'
            sourceFieldName: 'order_type'
            granularity: 'Order'
            uniqueKey: 'order_id'
            dataType: 'count'
            department: 'Executive'
            dataOwner: ''
            businessOwner: ''
            note: '$250 threshold prevents sample orders with small add-ons from counting as product orders'

          - kpiName: 'Sample Orders'
            acronym: ''
            description: 'Orders with sample_quantity > 0 AND product_quantity = 0'
            calculation: 'count where order_type = Sample Order'
            sourceFieldName: 'order_type'
            granularity: 'Order'
            uniqueKey: 'order_id'
            dataType: 'count'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Core sample funnel metric'

          - kpiName: 'Average Order Value'
            acronym: 'AOV'
            description: 'Average net sales per order'
            calculation: 'sum(net_sales) / count(order_id)'
            sourceFieldName: 'net_sales'
            granularity: 'Order'
            uniqueKey: 'order_id'
            dataType: 'currency'
            department: 'Executive'
            dataOwner: ''
            businessOwner: ''
            note: 'Key executive metric'

          - kpiName: 'Lifetime Product Revenue'
            acronym: 'LTV Revenue'
            description: 'Cumulative product revenue at time of order'
            calculation: 'sum(product_revenue) over (partition by email order by processed_at)'
            sourceFieldName: 'lifetime_product_revenue'
            granularity: 'Order'
            uniqueKey: 'order_id'
            dataType: 'currency'
            department: 'Customer Intelligence'
            dataOwner: ''
            businessOwner: ''
            note: 'Running total per customer - wishlist section 4.2'

          - kpiName: 'New vs Returning Customer'
            acronym: ''
            description: 'Customer status at time of order'
            calculation: 'case statement based on first order dates'
            sourceFieldName: 'customer_status'
            granularity: 'Order'
            uniqueKey: 'order_id'
            dataType: 'classification'
            department: 'Customer Intelligence'
            dataOwner: ''
            businessOwner: ''
            note: 'Wishlist section 4.1 - segmentation'

    columns:
      - name: order_id
        description: Unique order identifier
        tests:
          - unique
          - not_null

      - name: email
        description: Customer email
        tests:
          - not_null
          - relationships:
              to: ref('dim_customers')
              field: email

      - name: order_date
        description: Order date in Pacific timezone
        tests:
          - not_null

      - name: order_type
        description: Order classification
        tests:
          - not_null
          - accepted_values:
              values: ['Product Order', 'Sample Order', 'Accessory Only', 'Other']

      - name: store
        description: Store identifier
        tests:
          - not_null
          - accepted_values:
              values: ['regular', 'commercial']

      - name: net_sales
        description: Order net sales (primary revenue metric)

      - name: lifetime_product_revenue
        description: Cumulative product revenue at time of this order

      - name: customer_status
        description: Customer status at time of order
        tests:
          - not_null
          - accepted_values:
              values: ['New Customer', 'New Customer Sample', 'Returning Sample', 'Returning Customer', 'Other']

  - name: fct_order_lines
    description: Line item-level fact table with order context and customer funnel
    config:
      meta:
        kpis:
          - kpiName: 'SKU Revenue'
            acronym: ''
            description: 'Revenue by product SKU'
            calculation: 'sum(line_total_price)'
            sourceFieldName: 'line_total_price'
            granularity: 'Line Item'
            uniqueKey: 'order_line_id'
            dataType: 'currency'
            department: 'Executive'
            dataOwner: ''
            businessOwner: ''
            note: 'Wishlist section 1.1 - revenue by SKU'

          - kpiName: 'SKU Units Sold'
            acronym: ''
            description: 'Quantity sold by SKU'
            calculation: 'sum(quantity)'
            sourceFieldName: 'quantity'
            granularity: 'Line Item'
            uniqueKey: 'order_line_id'
            dataType: 'count'
            department: 'Executive'
            dataOwner: ''
            businessOwner: ''
            note: 'Product performance metric'

          - kpiName: 'Sample vs Product Distribution'
            acronym: ''
            description: 'Classification of line items as Sample, Product, or Accessories'
            calculation: 'line item classification business rules'
            sourceFieldName: 'line_item_type'
            granularity: 'Line Item'
            uniqueKey: 'order_line_id'
            dataType: 'classification'
            department: 'Operations'
            dataOwner: ''
            businessOwner: ''
            note: 'Core business rule - see business_rules.md section 1'

          - kpiName: 'Converted Purchases'
            acronym: ''
            description: 'Product purchases that occurred after customer sampled'
            calculation: 'count where is_converted_purchase = true'
            sourceFieldName: 'is_converted_purchase'
            granularity: 'Line Item'
            uniqueKey: 'order_line_id'
            dataType: 'count'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Sample program effectiveness - wishlist section 3.2'

          - kpiName: 'Product Category Revenue'
            acronym: ''
            description: 'Revenue by product category (Base, Signature, Craftsman, etc.)'
            calculation: 'sum(line_total_price) group by product_category'
            sourceFieldName: 'product_category'
            granularity: 'Line Item'
            uniqueKey: 'order_line_id'
            dataType: 'currency'
            department: 'Executive'
            dataOwner: ''
            businessOwner: ''
            note: 'Derived from SKU patterns - business_rules.md section 3'

    columns:
      - name: order_line_id
        description: Unique line item identifier
        tests:
          - unique
          - not_null

      - name: order_id
        description: Foreign key to fct_orders
        tests:
          - not_null
          - relationships:
              to: ref('fct_orders')
              field: order_id

      - name: email
        description: Customer email
        tests:
          - not_null
          - relationships:
              to: ref('dim_customers')
              field: email

      - name: sku
        description: Product SKU

      - name: line_item_type
        description: Line item classification
        tests:
          - not_null
          - accepted_values:
              values: ['Sample', 'Product', 'Accessories']

      - name: color
        description: Product color extracted from title

      - name: is_converted_purchase
        description: Boolean flag for purchases after sampling

  - name: dim_customers
    description: Customer dimension with lifetime metrics and funnel status
    config:
      meta:
        kpis:
          - kpiName: 'Customer Lifetime Value'
            acronym: 'LTV'
            description: 'Total lifetime revenue per customer (product orders only)'
            calculation: 'sum(product_revenue) per customer'
            sourceFieldName: 'lifetime_product_revenue'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'currency'
            department: 'Customer Intelligence'
            dataOwner: ''
            businessOwner: ''
            note: 'Wishlist section 4.2 - revenue LTV'

          - kpiName: 'Total Customer Lifetime Value'
            acronym: 'Total LTV'
            description: 'Total lifetime revenue including samples and accessories'
            calculation: 'sum(all_revenue) per customer'
            sourceFieldName: 'lifetime_total_revenue'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'currency'
            department: 'Customer Intelligence'
            dataOwner: ''
            businessOwner: ''
            note: 'Complete customer value'

          - kpiName: 'Days to Order'
            acronym: 'Sample Conversion Time'
            description: 'Days from first sample to first product order'
            calculation: 'date_diff(first_product_order_date, first_sample_order_date, day)'
            sourceFieldName: 'days_to_order'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'duration'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Core sample funnel metric - wishlist section 3.2'

          - kpiName: 'Sample-to-Purchase Conversion'
            acronym: 'Conversion Rate'
            description: 'Whether customer converted from sample to product purchase'
            calculation: 'max(is_product_order) per customer'
            sourceFieldName: 'conversion_ind'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'boolean'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Key sample program KPI - wishlist section 3.2'

          - kpiName: 'Customer Value Segment'
            acronym: ''
            description: 'Customer segmentation by lifetime value (High/Medium/Low/Sample Only/No Purchase)'
            calculation: 'segmentation based on lifetime_product_revenue thresholds'
            sourceFieldName: 'customer_segment'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'classification'
            department: 'Customer Intelligence'
            dataOwner: ''
            businessOwner: ''
            note: 'Wishlist section 4.1 - customer segmentation'

          - kpiName: 'Customer Group'
            acronym: ''
            description: 'Customer classification (Retail, Trade Rewards, Pending Trade Rewards)'
            calculation: 'derived from customer tags'
            sourceFieldName: 'customer_group'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'classification'
            department: 'Customer Intelligence'
            dataOwner: ''
            businessOwner: ''
            note: 'Business rule - business_rules.md section 4'

    columns:
      - name: email
        description: Customer email (primary key)
        tests:
          - unique
          - not_null

      - name: customer_group
        description: Customer group
        tests:
          - not_null
          - accepted_values:
              values: ['Retail', 'Trade Rewards', 'Pending Trade Rewards']

      - name: customer_type
        description: Customer type
        tests:
          - not_null

      - name: first_sample_order_date
        description: Date of first sample order

      - name: first_product_order_date
        description: Date of first product order

      - name: days_to_order
        description: Days from first sample to first product order

      - name: lifetime_product_revenue
        description: Total lifetime product revenue

      - name: lifetime_total_revenue
        description: Total lifetime revenue (all order types)

      - name: conversion_ind
        description: Boolean flag indicating if customer converted from sample to product

      - name: customer_segment
        description: Customer value segment
        tests:
          - not_null
          - accepted_values:
              values: ['High Value', 'Medium Value', 'Low Value', 'Sample Only', 'No Purchase']

  - name: fct_sample_conversions
    description: |
      Sample-to-purchase funnel with conversion timing and revenue metrics.
      Enhanced with household-level conversion tracking to capture conversions
      where customers use different emails for samples vs products but ship to same address.
    config:
      meta:
        kpis:
          - kpiName: 'Email-Based Conversion Rate'
            acronym: 'Email CVR'
            description: 'Percentage of sample customers who purchased using the same email'
            calculation: 'sum(conversion_ind) / count(email) * 100'
            sourceFieldName: 'conversion_ind'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'percentage'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Original conversion tracking - wishlist section 3.2'

          - kpiName: 'Household Conversion Rate'
            acronym: 'Household CVR'
            description: 'Percentage of sample households who purchased (any email in household)'
            calculation: 'sum(household_conversion_ind) / count(email) * 100'
            sourceFieldName: 'household_conversion_ind'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'percentage'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Enhanced tracking for multi-email households - captures work vs personal email conversions'

          - kpiName: 'Hybrid Conversion Rate'
            acronym: 'Total CVR'
            description: 'Complete conversion picture - email OR household conversion'
            calculation: 'sum(hybrid_conversion_ind) / count(email) * 100'
            sourceFieldName: 'hybrid_conversion_ind'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'percentage'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Most accurate conversion metric - recommended for reporting'

          - kpiName: '15-Day Conversion Rate'
            acronym: '15d CVR'
            description: 'Percentage of customers who converted within 15 days of first sample'
            calculation: 'sum(converted_within_15d) / count(email) * 100'
            sourceFieldName: 'converted_within_15d'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'percentage'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Conversion window analysis - wishlist section 3.2'

          - kpiName: '30-Day Conversion Rate'
            acronym: '30d CVR'
            description: 'Percentage of customers who converted within 30 days of first sample'
            calculation: 'sum(converted_within_30d) / count(email) * 100'
            sourceFieldName: 'converted_within_30d'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'percentage'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Standard conversion window'

          - kpiName: '60-Day Conversion Rate'
            acronym: '60d CVR'
            description: 'Percentage of customers who converted within 60 days of first sample'
            calculation: 'sum(converted_within_60d) / count(email) * 100'
            sourceFieldName: 'converted_within_60d'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'percentage'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Extended conversion window'

          - kpiName: '120-Day Conversion Rate'
            acronym: '120d CVR'
            description: 'Percentage of customers who converted within 120 days of first sample'
            calculation: 'sum(converted_within_120d) / count(email) * 100'
            sourceFieldName: 'converted_within_120d'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'percentage'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Maximum tracked conversion window'

          - kpiName: 'Average Days to Order'
            acronym: 'Time to Convert'
            description: 'Average days from first sample to first product purchase'
            calculation: 'avg(days_to_order) where conversion_ind = 1'
            sourceFieldName: 'days_to_order'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'duration'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Critical for remarketing timing - wishlist section 3.2'

          - kpiName: 'Sample Order Type Distribution'
            acronym: ''
            description: 'Classification of samples by product category (Base Only, Signature Only, etc.)'
            calculation: 'sample_order_type classification'
            sourceFieldName: 'sample_order_type'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'classification'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Sample program optimization - wishlist section 3.2'

          - kpiName: 'Household Email Count'
            acronym: ''
            description: 'Number of unique emails per household'
            calculation: 'count(distinct email) per household_id'
            sourceFieldName: 'household_email_count'
            granularity: 'Customer'
            uniqueKey: 'email'
            dataType: 'count'
            department: 'Customer Intelligence'
            dataOwner: ''
            businessOwner: ''
            note: 'Identifies multi-email households for better conversion tracking'

    columns:
      - name: email
        description: Customer email (primary key)
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('dim_customers')
              field: email

      # Email-based conversion metrics (original logic)
      - name: first_sample_order_date
        description: Date of first sample order (email-based)
        tests:
          - not_null

      - name: first_product_order_date
        description: Date of first product order (email-based, null if no conversion)

      - name: days_to_order
        description: Days from first sample to first product order (email-based)

      - name: conversion_ind
        description: Boolean flag for conversion (email-based)
        tests:
          - not_null

      - name: converted_within_15d
        description: Boolean flag for conversion within 15 days (email-based)

      - name: converted_within_30d
        description: Boolean flag for conversion within 30 days (email-based)

      - name: converted_within_60d
        description: Boolean flag for conversion within 60 days (email-based)

      - name: converted_within_120d
        description: Boolean flag for conversion within 120 days (email-based)

      # Household identification (NEW)
      - name: household_id
        description: Household identifier based on normalized shipping address

      - name: household_email_count
        description: Number of unique emails in this household

      # Household conversion metrics (NEW)
      - name: household_first_sample_order_date
        description: Date of household's first sample order (any email in household)

      - name: household_first_product_order_date
        description: Date of household's first product order (any email in household)

      - name: household_days_to_order
        description: Days from first sample to first product order (household-based)

      - name: household_conversion_ind
        description: Boolean flag for household conversion (any email in household)

      - name: household_converted_within_15d
        description: Boolean flag for household conversion within 15 days

      - name: household_converted_within_30d
        description: Boolean flag for household conversion within 30 days

      - name: household_converted_within_60d
        description: Boolean flag for household conversion within 60 days

      - name: household_converted_within_120d
        description: Boolean flag for household conversion within 120 days

      # Hybrid conversion (NEW - email OR household)
      - name: hybrid_conversion_ind
        description: Boolean flag for conversion at email level OR household level (captures all conversions)

      - name: sample_order_type
        description: Classification of sample orders
        tests:
          - not_null

      - name: cohort_month
        description: Cohort month (first sample order month)

      - name: conversion_window_bucket
        description: Time-based conversion bucket (email-based)
        tests:
          - not_null
          - accepted_values:
              values: ['No Conversion', '0-15 days', '16-30 days', '31-60 days', '61-120 days', '120+ days']

      - name: household_conversion_window_bucket
        description: Time-based conversion bucket (household-based)
        tests:
          - not_null
          - accepted_values:
              values: ['No Conversion', '0-15 days', '16-30 days', '31-60 days', '61-120 days', '120+ days']

      - name: hybrid_conversion_window_bucket
        description: Time-based conversion bucket (hybrid - uses earliest conversion)
        tests:
          - not_null
          - accepted_values:
              values: ['No Conversion', '0-15 days', '16-30 days', '31-60 days', '61-120 days', '120+ days']

      - name: product_orders_within_60d
        description: Count of product orders within 60 days of first sample

  - name: fct_daily_performance
    description: Daily aggregated performance metrics with ad spend and CAC/ROAS
    config:
      meta:
        kpis:
          - kpiName: 'Customer Acquisition Cost'
            acronym: 'CAC'
            description: 'Cost to acquire a new customer (ad spend / new customers)'
            calculation: 'total_ad_spend / new_customers'
            sourceFieldName: 'cac'
            granularity: 'Daily'
            uniqueKey: 'date_day, store'
            dataType: 'currency'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Wishlist section 3.1 - CAC by channel'

          - kpiName: 'Return on Ad Spend'
            acronym: 'ROAS'
            description: 'Revenue generated per dollar spent on advertising'
            calculation: 'total_revenue / total_ad_spend'
            sourceFieldName: 'roas'
            granularity: 'Daily'
            uniqueKey: 'date_day, store'
            dataType: 'ratio'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Wishlist section 3.1 - ROAS by channel and cohort'

          - kpiName: 'Daily Revenue'
            acronym: ''
            description: 'Total revenue for the day'
            calculation: 'sum(net_sales)'
            sourceFieldName: 'total_revenue'
            granularity: 'Daily'
            uniqueKey: 'date_day, store'
            dataType: 'currency'
            department: 'Executive'
            dataOwner: ''
            businessOwner: ''
            note: 'Wishlist section 1.1 - company health metrics'

          - kpiName: 'Daily Product Revenue'
            acronym: ''
            description: 'Product order revenue for the day'
            calculation: 'sum(net_sales) where is_product_order = true'
            sourceFieldName: 'product_revenue'
            granularity: 'Daily'
            uniqueKey: 'date_day, store'
            dataType: 'currency'
            department: 'Executive'
            dataOwner: ''
            businessOwner: ''
            note: 'Key executive metric'

          - kpiName: 'Daily Total Orders'
            acronym: ''
            description: 'Total orders placed for the day'
            calculation: 'count(order_id)'
            sourceFieldName: 'total_orders'
            granularity: 'Daily'
            uniqueKey: 'date_day, store'
            dataType: 'count'
            department: 'Executive'
            dataOwner: ''
            businessOwner: ''
            note: 'Executive scorecard - wishlist section 11.3'

          - kpiName: 'Daily Product Orders'
            acronym: ''
            description: 'Product orders placed for the day'
            calculation: 'count where is_product_order = true'
            sourceFieldName: 'product_orders'
            granularity: 'Daily'
            uniqueKey: 'date_day, store'
            dataType: 'count'
            department: 'Executive'
            dataOwner: ''
            businessOwner: ''
            note: 'Core executive metric'

          - kpiName: 'New Customers Acquired'
            acronym: ''
            description: 'Number of new customers acquired'
            calculation: 'count distinct email where first_order_date = date_day'
            sourceFieldName: 'new_customers'
            granularity: 'Daily'
            uniqueKey: 'date_day, store'
            dataType: 'count'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Wishlist section 4.1 - new vs returning'

          - kpiName: 'Returning Customers'
            acronym: ''
            description: 'Number of returning customers'
            calculation: 'count distinct email where first_order_date < date_day'
            sourceFieldName: 'returning_customers'
            granularity: 'Daily'
            uniqueKey: 'date_day, store'
            dataType: 'count'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Customer retention metric'

    columns:
      - name: date_day
        description: Performance date
        tests:
          - not_null

      - name: store
        description: Store identifier
        tests:
          - not_null
          - accepted_values:
              values: ['regular', 'commercial']

      - name: total_orders
        description: Total orders for the day

      - name: product_orders
        description: Product orders for the day

      - name: total_revenue
        description: Total revenue for the day

      - name: product_revenue
        description: Product revenue for the day

      - name: total_ad_spend
        description: Total ad spend (Facebook + Google)

      - name: cac
        description: Customer acquisition cost (ad spend / new customers)

      - name: roas
        description: Return on ad spend (revenue / ad spend)

      - name: new_customers
        description: New customers acquired

      - name: returning_customers
        description: Returning customers

  - name: fct_weekly_product_sales
    description: Weekly product sales aggregated by SKU
    config:
      meta:
        kpis:
          - kpiName: 'Weekly SKU Revenue'
            acronym: ''
            description: 'Total revenue by SKU for the week'
            calculation: 'sum(line_total_price)'
            sourceFieldName: 'total_revenue'
            granularity: 'Weekly'
            uniqueKey: 'week_start_date, sku, store'
            dataType: 'currency'
            department: 'Executive'
            dataOwner: ''
            businessOwner: ''
            note: 'Product performance - wishlist section 1.1'

          - kpiName: 'Weekly SKU Units Sold'
            acronym: ''
            description: 'Total units sold by SKU for the week'
            calculation: 'sum(quantity)'
            sourceFieldName: 'total_quantity'
            granularity: 'Weekly'
            uniqueKey: 'week_start_date, sku, store'
            dataType: 'count'
            department: 'Operations'
            dataOwner: ''
            businessOwner: ''
            note: 'Demand forecasting input - wishlist section 2.2'

          - kpiName: 'Weekly SKU Customer Count'
            acronym: ''
            description: 'Number of unique customers who purchased this SKU'
            calculation: 'count distinct email'
            sourceFieldName: 'unique_customers'
            granularity: 'Weekly'
            uniqueKey: 'week_start_date, sku, store'
            dataType: 'count'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Product popularity metric'

          - kpiName: 'Converted Purchases by SKU'
            acronym: ''
            description: 'Purchases after sampling this product'
            calculation: 'count where is_converted_purchase = true'
            sourceFieldName: 'converted_purchases'
            granularity: 'Weekly'
            uniqueKey: 'week_start_date, sku, store'
            dataType: 'count'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Sample program effectiveness by SKU - wishlist section 3.2'

    columns:
      - name: week_start_date
        description: Week start date
        tests:
          - not_null

      - name: sku
        description: Product SKU
        tests:
          - not_null

      - name: line_item_type
        description: Line item type
        tests:
          - not_null
          - accepted_values:
              values: ['Sample', 'Product', 'Accessories']

      - name: store
        description: Store identifier
        tests:
          - not_null
          - accepted_values:
              values: ['regular', 'commercial']

      - name: total_quantity
        description: Total units sold

      - name: total_revenue
        description: Total revenue

      - name: order_count
        description: Number of orders containing this SKU

      - name: unique_customers
        description: Number of unique customers who purchased this SKU

      - name: converted_purchases
        description: Number of purchases after sampling this product

  - name: fct_monthly_cohorts
    description: Monthly customer cohort retention and LTV analysis
    config:
      meta:
        kpis:
          - kpiName: 'Cohort Retention Rate'
            acronym: 'Retention %'
            description: 'Percentage of cohort customers still active N months later'
            calculation: 'active_customers / cohort_size * 100'
            sourceFieldName: 'retention_rate'
            granularity: 'Monthly'
            uniqueKey: 'cohort_month, months_since_first_order, store'
            dataType: 'percentage'
            department: 'Customer Intelligence'
            dataOwner: ''
            businessOwner: ''
            note: 'Wishlist section 4.2 - customer retention'

          - kpiName: 'Cumulative Lifetime Value'
            acronym: 'Cumulative LTV'
            description: 'Total LTV accumulated up to N months from cohort start'
            calculation: 'sum(revenue) per cohort up to month N'
            sourceFieldName: 'cumulative_ltv'
            granularity: 'Monthly'
            uniqueKey: 'cohort_month, months_since_first_order, store'
            dataType: 'currency'
            department: 'Customer Intelligence'
            dataOwner: ''
            businessOwner: ''
            note: 'LTV by cohort - wishlist section 4.2'

          - kpiName: 'LTV per Customer'
            acronym: 'Avg LTV'
            description: 'Average LTV per customer in cohort'
            calculation: 'cumulative_ltv / cohort_size'
            sourceFieldName: 'cumulative_ltv_per_customer'
            granularity: 'Monthly'
            uniqueKey: 'cohort_month, months_since_first_order, store'
            dataType: 'currency'
            department: 'Customer Intelligence'
            dataOwner: ''
            businessOwner: ''
            note: 'Per-customer value metric'

          - kpiName: 'Cohort Size'
            acronym: ''
            description: 'Number of customers in cohort'
            calculation: 'count distinct email'
            sourceFieldName: 'cohort_size'
            granularity: 'Monthly'
            uniqueKey: 'cohort_month, months_since_first_order, store'
            dataType: 'count'
            department: 'Customer Intelligence'
            dataOwner: ''
            businessOwner: ''
            note: 'Cohort analysis baseline'

    columns:
      - name: cohort_month
        description: First product order month (cohort identifier)
        tests:
          - not_null

      - name: store
        description: Store identifier
        tests:
          - not_null
          - accepted_values:
              values: ['regular', 'commercial']

      - name: months_since_first_order
        description: Months since cohort month (0 = first month)
        tests:
          - not_null

      - name: cohort_size
        description: Number of customers in cohort

      - name: active_customers
        description: Customers who ordered in this relative month

      - name: retention_rate
        description: Retention rate (active_customers / cohort_size * 100)

      - name: cohort_revenue
        description: Total revenue from cohort in this month

      - name: cumulative_ltv
        description: Cumulative lifetime value up to this month

      - name: cumulative_ltv_per_customer
        description: Cumulative LTV divided by cohort size

      - name: calendar_month
        description: Actual calendar month for time series visualization

  - name: fct_unit_economics
    description: Order-level unit economics with contribution margin before COGS (YELLOW metric - COGS not available)
    config:
      meta:
        kpis:
          - kpiName: 'Contribution Margin (before COGS)'
            acronym: 'CM'
            description: 'Net sales minus variable costs (shipping + ad spend) - DOES NOT include COGS'
            calculation: 'net_sales - shipping_cost - allocated_ad_spend'
            sourceFieldName: 'contribution_margin_before_cogs'
            granularity: 'Order'
            uniqueKey: 'order_id'
            dataType: 'currency'
            department: 'Financial'
            dataOwner: ''
            businessOwner: ''
            note: 'YELLOW METRIC - Missing COGS data. Wishlist section 1.1, 1.2. See ASSUMPTIONS_AND_LIMITATIONS.md'

          - kpiName: 'Contribution Margin Percentage'
            acronym: 'CM %'
            description: 'Contribution margin as percentage of net sales'
            calculation: 'contribution_margin_before_cogs / net_sales * 100'
            sourceFieldName: 'contribution_margin_pct'
            granularity: 'Order'
            uniqueKey: 'order_id'
            dataType: 'percentage'
            department: 'Financial'
            dataOwner: ''
            businessOwner: ''
            note: 'YELLOW METRIC - Missing COGS data'

          - kpiName: 'Shipping Cost Percentage'
            acronym: 'Shipping %'
            description: 'Shipping cost as percentage of net sales'
            calculation: 'shipping_cost / net_sales * 100'
            sourceFieldName: 'shipping_cost_pct'
            granularity: 'Order'
            uniqueKey: 'order_id'
            dataType: 'percentage'
            department: 'Operations'
            dataOwner: ''
            businessOwner: ''
            note: 'Cost structure analysis - wishlist section 1.2'

          - kpiName: 'Ad Spend Percentage'
            acronym: 'Ad Spend %'
            description: 'Ad spend as percentage of net sales (allocated to new customers)'
            calculation: 'allocated_ad_spend / net_sales * 100'
            sourceFieldName: 'ad_spend_pct'
            granularity: 'Order'
            uniqueKey: 'order_id'
            dataType: 'percentage'
            department: 'Marketing'
            dataOwner: ''
            businessOwner: ''
            note: 'Marketing efficiency metric'

          - kpiName: 'Discount Amount'
            acronym: ''
            description: 'Total discounts applied to order'
            calculation: 'order discount total'
            sourceFieldName: 'discount_amount'
            granularity: 'Order'
            uniqueKey: 'order_id'
            dataType: 'currency'
            department: 'Financial'
            dataOwner: ''
            businessOwner: ''
            note: 'Pricing & promotion - wishlist section 7'

    columns:
      - name: order_id
        description: Unique order identifier
        tests:
          - unique
          - not_null

      - name: email
        description: Customer email
        tests:
          - not_null

      - name: order_date
        description: Order date
        tests:
          - not_null

      - name: store
        description: Store identifier
        tests:
          - not_null
          - accepted_values:
              values: ['regular', 'commercial']

      - name: order_type
        description: Order classification
        tests:
          - not_null
          - accepted_values:
              values: ['Product Order']

      - name: gross_revenue
        description: Revenue before discounts

      - name: discount_amount
        description: Total discounts applied

      - name: net_sales
        description: Revenue after discounts

      - name: shipping_cost
        description: Shipping cost from Freightview

      - name: allocated_ad_spend
        description: Ad spend allocated to new customers

      - name: total_variable_costs
        description: Shipping + ad spend

      - name: contribution_margin_before_cogs
        description: Net sales - variable costs (DOES NOT include COGS)

      - name: contribution_margin_pct
        description: Contribution margin as percentage of net sales

      - name: shipping_cost_pct
        description: Shipping cost as percentage of net sales

      - name: ad_spend_pct
        description: Ad spend as percentage of net sales

  - name: fct_demand_forecast_prep
    description: Time series data prepared for demand forecasting models with seasonality and trend features
    columns:
      - name: date_day
        description: Daily grain date
        tests:
          - not_null

      - name: store
        description: Store identifier (regular or commercial)
        tests:
          - not_null
          - accepted_values:
              values: ['regular', 'commercial']

      - name: sku
        description: Product SKU
        tests:
          - not_null

      - name: line_item_type
        description: Line item type (should be Product for forecasting)
        tests:
          - not_null
          - accepted_values:
              values: ['Product']

      - name: quantity_sold
        description: Units sold on this day

      - name: revenue
        description: Revenue generated on this day

      - name: day_of_week
        description: Day of week (1=Sunday, 7=Saturday)

      - name: is_weekend
        description: Boolean flag for weekend days

      - name: is_holiday_week
        description: Boolean flag for major holiday weeks
